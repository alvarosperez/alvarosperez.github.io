"use strict";var colorlegend=function(a,b,c,d){var e=["linear","quantile","ordinal"],f=!1,g=d||{},h=g.boxWidth||20,i=g.boxHeight||20,j=g.title||null,k=g.fill||!1,l=g.linearBoxes||9,m=document.getElementById("#"===a.substring(0,1)?a.substring(1,a.length):a),n=m.offsetWidth,o=m.offsetHeight,p=[],q=[2,4,10,4],r="ordinal"===c?3:0,s=j?11:0,t=b.domain(),u=b.range(),v=0;for(v=0;v<e.length;v++)if(e[v]===c){f=!0;break}if(!f)throw new Error("Scale type, "+c+", is not suported.");if("quantile"===c)p=u;else if("ordinal"===c)for(v=0;v<t.length;v++)p[v]=u[v];else if("linear"===c){var w=t[0],x=t[t.length-1];for(v=0;l>v;v++)p[v]=b(w+v*((x-w)/l))}(k||n<(h+r)*p.length+q[1]+q[3])&&(h=(n-q[1]-q[3]-r*p.length)/p.length),(k||o<i+q[0]+q[2]+s)&&(i=o-q[0]-q[2]-s);var y=d3.select(a).append("svg").attr("width",n).attr("height",o).append("g").attr("class","colorlegend").attr("transform","translate("+q[3]+","+q[0]+")").style("font-size","11px").style("fill","#666"),z=y.selectAll("g.legend").data(p).enter().append("g");return z.append("text").attr("class","colorlegend-labels").attr("dy",".71em").attr("x",function(a,b){return b*(h+r)+("ordinal"!==c?h/2:0)}).attr("y",function(){return i+2}).style("text-anchor",function(){return"ordinal"===c?"start":"middle"}).style("pointer-events","none").text(function(a,b){return"ordinal"===c?t[b]:0===b?t[0]:b===p.length-1?t[t.length-1]:void 0}),z.append("rect").attr("x",function(a,b){return b*(h+r)}).attr("width",h).attr("height",i).style("fill",function(a,b){return p[b]}),j&&y.append("text").attr("class","colorlegend-title").attr("x",p.length*(h/2)).attr("y",i+s).attr("dy",".71em").style("text-anchor","middle").style("pointer-events","none").text(j),this},tdviz=tdviz||{version:.9,controller:{},viz:{},extras:{},comm:{}};tdviz.extras.help=function(a,b,c){var d={};d.idName=a,d.className=b;for(var e in c)d[e]=c[e];d._fill_help=function(a){var b="",c=d.help_data[a],e=c.header,f=c.text,g=c.image;b+='<a name="'+d.idName+"_"+i+'"><h1>'+e+"</h1></a>",b+="<div>"+f+"</div>",null!=g&&(b+='<div class="img_div"><img src="'+d.path_help+"/"+g+'"></div>');for(var h=[],i=0;i<d.help_data.length;i++)e=d.help_data[i].header,h.push(i==a?'<span class="help_link selected">'+e+"</span>":'<span class="help_link">'+e+"</span>");d.help_content.transition().style("opacity",0).each("end",function(){d3.select(this).html(b).transition().style("opacity",1)}),d.help_header.html(h.join(" | ")),d3.selectAll("#"+d.idName+" .help_link").on("click",function(a,b){return d._fill_help(b),!1})},d.init=function(){d.parent=d3.select("#"+d.idName),d.visible_help=!1,d3.json(d.path_help+"/"+d.data_file,function(a,b){a?console.warn(a):(d.help_data=b,d.help_button=d.parent.append("i").attr("class","help_button fa fa-info-circle fa-2x").on("click",function(){d.visible_help=!d.visible_help,d.help_div.transition().style("opacity",function(){return d.visible_help?1:0}),d.help_div.transition().style("display",function(){return d.visible_help?"":"none"}),d.help_button.transition().style("opacity",function(){return d.visible_help?0:1})}),d.help_div=d.parent.append("div").attr("class","help_panel").style("opacity",1).style("display","none").html(""),d.close_button=d.help_div.append("i").attr("class","close_button fa fa-times").on("click",function(){d.visible_help=!d.visible_help,d.help_div.transition().style("opacity",function(){return d.visible_help?1:0}),d.help_div.transition().style("display",function(){return d.visible_help?"":"none"}),d.help_button.transition().style("opacity",function(){return d.visible_help?0:1})}),d.help_header=d.help_div.append("div").attr("class","header"),d.help_content=d.help_div.append("div").attr("class","content"),d._fill_help(0))})},d.init()};var tdviz=tdviz||{version:.9,controller:{},viz:{},extras:{},comm:{}};tdviz.controller.kpiViewer=function(a,b,c){var d={};for(var e in c)d[e]=c[e];return d.idName=a,d.className=b,d.controls={},d.myLog=function(a,b){0!=d.debugLevel&&b<=d.debugLevel&&console.log(a)},d.renderFile=function(a,b){d3.json(d.baseJUrl+a,function(c){null!=c?d.mapChart.render(c,b):d.myLog("Could not load file: "+d.baseJUrl+a,1)})},d.getControlsFile=function(a,b){d3.json(d.baseJUrl+a,function(c){null!=c?b(c):d.myLog("Could not load file: "+d.baseJUrl+a,1)})},d.getProfilesFile=function(a,b){d3.json(d.baseJUrl+a,function(c){null!=c?b(c):d.myLog("Could not load file: "+d.baseJUrl+a,1)})},d.setScales=function(){d.myLog("setScales",5),d.profileData.forEach(function(a){a.scales={};for(var b in d.infoDict)a.scales[b]=d3.scale.linear().range(d.infoDict[b].rangeScale).domain([10,30]).clamp(!0);a.max=30}),d.myLog(d.profileData,5)},d.setCurrentDataset=function(){d.myLog("setCurrentDataset",5);var a=d.profileData.filter(function(a){return a.consumo==d.controls.consumo&&a.period==d.controls.period&&a.segment==d.controls.segment?a:void 0});d.currentDataset=a[0],d.totalClientsCountry=d.currentDataset.total_peru,d.totalClientsRegion=d.currentDataset.total_lima,d.myLog(d.currentDataset,5)},d.getSeriesSubtitle=function(a,b,c){d.myLog("getSeriesSubtitle",5);var e="<b>",f=d.totalClientsCountry;"distrits"==d.tabSelected&&(f=d.totalClientsRegion);var g=(c/f*100).toFixed(2);return e+=d.infoDict[d.tabSelected].label+': <font color="'+b+'">'+a+'</font>&nbsp;&nbsp; Customers: <font color="'+b+'">'+c+" ("+g+"% de "+f+" total customers)</font>",e+="</b>"},d.getValueD=function(a){d.myLog("getValueD",5),d.myLog(d.tabSelected+","+JSON.stringify(a),5);var b="";return"provinces"==d.tabSelected?b=a.properties.nombre:"distrits"==d.tabSelected&&(b=a.properties.NOMBDIST),b},d.getPeople=function(a){d.myLog("getPeople",5),d.myLog(d.tabSelected+","+JSON.stringify(a),5);var b="";return d.currentDataset[d.tabSelected].forEach(function(c){c.id==a.id&&(b=c.properties.Clients_total)}),b},d.getDataD=function(a){d.myLog("getDataD",5);var b=[];return d.currentDataset[d.tabSelected].forEach(function(c){c.id==a&&(b=c.properties.detail)}),b},d.getCurrentScale=function(a){return d.currentDataset.scales[d.tabSelected](a)},d.callBacks={polygon:{enter:function(a){d.myLog("enter callback",4),a.attr("d",d.mapChart.path).transition(d.transTime).style("fill",function(a,b){return d.getCurrentScale(d.heatData[b])})},zoom:function(a){a.attr("d",d.mapChart.path)},update:function(a){d.myLog("update callback",4),a.attr("d",d.mapChart.path).transition(d.transTime).style("fill",function(a,b){return d.getCurrentScale(d.heatData[b])})},click:function(a,b){d.myLog("click callback",4),d.myLog(a,6),d.myLog(d.heatData[b],6),d.myLog(d.infoDict[d.tabSelected]+" "+d.getValueD(a)+" clickada",6),d.myLog("Click callback",4),d.timeSeriesTitle.html("Client distribution by data usage and segment"),d.timeSeriesSubtitle.html(d.getSeriesSubtitle(d.getValueD(a),d.infoDict[d.tabSelected].maxColor,d.getPeople(a))),d.myLog("province: "+d.getValueD(a),3);var c=d.getDataD(a.id),e=Math.min.apply(null,c),f=Math.max.apply(null,c),g=["Bronze","Silver","Gold"];2==d.controls.segment?g=["Bronze"]:3==d.controls.segment?g=["Silver"]:4==d.controls.segment&&(g=["Gold"]),d.timeSeriesViz.color_scale=d3.scale.linear().domain([e,f]).range(d.infoDict[d.tabSelected].rangeScale).clamp(!0),d.timeSeriesViz.size_scale=d3.scale.sqrt().domain([e,f]).range([2,30]).clamp(!0),d.timeSeriesViz.labels[0]=g,d.timeSeriesViz.render(c),d.timeSeriesContainer.style("opacity",1)},over:function(a,b){d.myLog("over callback",5),d.myLog(a,6);var c="";c+=d.getValueD(a)+"</br>",c+='<b><font color="'+d.infoDict[d.tabSelected].maxColor+'">'+d.heatData[b]+" GB / "+d.getPeople(a)+" Consumers</font></b>",d.mapChart.tooltip.html(c),d.mapChart.tooltip.style("opacity",1)},out:function(){d.mapChart.tooltip.style("opacity",0)}}},d.getValues=function(){d.myLog("getValues",5);var a=[],b={};console.log(d.tabSelected),d.currentDataset[d.tabSelected].forEach(function(a){b[a.id]=a.properties.Consumo_total});var c=d.countryData;return"distrits"==d.tabSelected&&(c=d.regionData),c.features.forEach(function(c){a.push(b[c.id])}),a},d.updateMap=function(a){d.myLog("updateMap",5),d.queryHeatMap(a,function(a){d.myLog("queryHeatMap callback",5),d.myLog(a,6),d.heatData=a,d.mapChart.updateValues([d.tabSelected])})},d.queryHeatMap=function(a,b){var c=a;d.myLog("queryHeatMap",5),d.myLog("heatmap[GET]:"+JSON.stringify(c),6);var e=d.getValues(a,d.infoDict[d.tabSelected].dataSize);b(e)},d.queryTimeSeries=function(a,b,c){var e=a;d.myLog("queryTimeSeries",5),a.province=b,d.myLog("timeSeries[GET]:"+JSON.stringify(e),6),c(d.getValues(a,24,d.heatData[b]))},d.changeMap=function(){d.myLog("changeMap",5),d.mapChart.map.removeLayer(d.marker),d.timeSeriesContainer.style("opacity",0);for(var a in d.infoDict)a!=d.tabSelected?d.mapChart.layerAttr(a,"visibility","hidden"):d.mapChart.layerAttr(a,"visibility","visible");d.mapChart.map.setView(new L.LatLng(d.infoDict[d.tabSelected].initLatLng[0],d.infoDict[d.tabSelected].initLatLng[1]),d.infoDict[d.tabSelected].zoomInit),d.updateMap(d.controls)},d.centerAt=function(a){d.myLog("centerAt",5),d.mapChart.map.removeLayer(d.marker);var b=d.mapChart.geoData[d.tabSelected].geoPolygons.filter(function(b){return b.id==a?b:void 0});if(b.length>0){for(var c=[],e=0;e<b[0].geometry.coordinates.length;e++){var f="Polygon"==b[0].geometry.type?b[0].geometry.coordinates[e]:b[0].geometry.coordinates[e][0];c=c.concat(f)}d.myLog("coordinates "+c,5);for(var g={lonmin:c[0][0],lonmax:c[0][0],latmin:c[0][1],latmax:c[0][1]},e=1;e<c.length;e++)g.lonmin=g.lonmin>c[e][0]?c[e][0]:g.lonmin,g.lonmax=g.lonmax<c[e][0]?c[e][0]:g.lonmax,g.latmin=g.latmin>c[e][1]?c[e][1]:g.latmin,g.latmax=g.latmax<c[e][1]?c[e][1]:g.latmax;center=new L.LatLng(g.latmin+(g.latmax-g.latmin)/2,g.lonmin+(g.lonmax-g.lonmin)/2),d.myLog("bounds "+JSON.stringify(g)+" center "+center,5);var h=L.AwesomeMarkers.icon({icon:"envelope-o",markerColor:"blue",prefix:"fa"});d.marker=L.marker(center,{icon:h}),d.myLog("create marker",5),d.mapChart.map.addLayer(d.marker),d.myLog("addLayer marker",5),d.mapChart.map.setView(center,12),d.myLog("setView",5)}else d.myLog("Not found "+a+". Not do anything!",5)},d.scaleLegend=function(){console.log("Adding legend to scale"),console.log(d.infoDict[d.tabSelected]),d.max="30 GB",d.min="10 GB";var a=d3.select(".leaflet-bottom.leaflet-left");a.selectAll("div").remove(),a.append("div").attr("id","scaleLegend").html("").attr("class","scaleLegend rotate"),a.selectAll("p").remove(),a.append("p").html(d.max).attr("style","position: absolute;margin-top: -205px;margin-left: 45px;color: gray;white-space:nowrap;"),a.append("p").html(d.min).attr("style","position: absolute;margin-top: -35px;margin-left: 45px;color: gray;white-space:nowrap;");var b=d3.scale.linear().domain([0,10]).range(d.infoDict[d.tabSelected].rangeScale);colorlegend("#scaleLegend",b,"linear",{title:"",boxHeight:23,boxWidth:23})},$(document).ready(function(){d.getControlsFile(d.controlsFile,function(a){d.myLog("Set controls",4),d.myLog(a,4),$.ajaxSetup({cache:!0}),d.vizOptions.callBackDict=d.callBacks,d.mapChart=tdviz.viz.mapViz(d.idName,d.className,d.vizOptions),d.infoDict={provinces:{method:d.changeMap,dataSize:25,maxColor:"#388DC3",rangeScale:["#FFFFFF","#388DC3"],label:"Departament",zoomInit:5,initLatLng:[-12.0433,-77.0283]},distrits:{method:d.changeMap,dataSize:43,maxColor:"#98C239",rangeScale:["#FFFFFF","#98C239"],label:"Distrit",zoomInit:10,initLatLng:[-12.0433,-77.0283]}};var b="";a.forEach(function(a){var c="";c+='<div class="infoContent">',c+='<span class="optionsLegend">'+a.label+'</span><form><select id="'+a.id+'" class="optionsSelect">';for(var e=0;e<a.items.length;e++)a.items[e].value!=a.selected?c+=a.items[e].hasOwnProperty("class")?'<option value="'+a.items[e].value+'" class="'+a.items[e]["class"]+'">'+a.items[e].label:'<option value="'+a.items[e].value+'">'+a.items[e].label:a.items[e].hasOwnProperty("class")?(c+='<option selected value="'+a.items[e].value+'" class="'+a.items[e]["class"]+'">'+a.items[e].label,c+="</option>",d.controls[a.id]=a.selected):(c+='<option selected value="'+a.items[e].value+'">'+a.items[e].label,c+="</option>",d.controls[a.id]=a.selected);c+="</select></form>",c+="</div>",d.myLog(c,5),b+=c}),d.myLog("#ready",5),d.myLog(b,5);var c=b;d.optionsBox=d3.select("#optionsBox").append("div").attr("id","infoFilters").html(c).attr("class","infoFilters"),a.forEach(function(a){a.hasOwnProperty("chained")&&$("#"+a.id).chained("#"+a.chained)}),d.timeSeriesContainer=d3.select("#optionsBox").append("div").attr("id","timeSeriesContainer").attr("class","timeSeriesContainer").style("opacity",0),d.timeSeriesTitle=d.timeSeriesContainer.append("div").attr("class","infoTitle").attr("id","timeSeriesTitle"),d.timeSeriesSubtitle=d.timeSeriesContainer.append("div").attr("class","infoSubTitle").attr("id","timeSeriesSubTitle"),d.timeSeriesBox=d.timeSeriesContainer.append("div").attr("id","timeSeriesBox").html("").attr("class","timeSeriesBox"),d.timeSeriesFooter=d.timeSeriesContainer.append("div").attr("id","timeSeriesFooter").attr("class","timeSeriesFooter"),d.timeSeriesViz=tdviz.viz.punchcard({id_name:"timeSeriesBox",width:600,height:350,header_margin:30,headers:["Segment","Data usage"],labels:[["Bronze","Silver","Gold"],["High (>40 GB)","Medium (6 - 40 GB)","Low (0.5 - 6 GB)","Lowest (<0.5 GB)"]],color_scale:d3.scale.linear().domain([0,1e4]).range(["#FFFFFF","#388DC3"]).clamp(!0),size_scale:d3.scale.sqrt().domain([0,1e4]).range([2,30]).clamp(!0),data:[]}),d.myLog("#query.timeSeriesContainer",4),d.myLog(d.timeSeriesContainer,4),a.forEach(function(a){d.myLog(a,4),$("#"+a.id).change(function(){d.controls[this.id]=this.value,d.myLog("change at #"+this.id+":"+JSON.stringify(d.controls,null,4),5),d.setCurrentDataset(),d.updateMap(d.controls),d.timeSeriesContainer.style("opacity",0),d.myLog(d.controls,4)})}),d.mapChart.addLayer("provinces"),d.mapChart.addLayer("distrits"),d.marker="",d.tabSelected="provinces",d.mapChart.layerAttr("distrits","visibility","hidden"),d.getProfilesFile(d.geoFileCountry,function(a){d.countryData=a,d.getProfilesFile(d.geoFileRegion,function(a){d.regionData=a,d.getProfilesFile(d.dataFile,function(a){d.profileData=a,d.myLog("Profile Dataset",4),d.myLog(d.profileData,4),d.setScales(),d.setCurrentDataset(),d.queryHeatMap(d.controls,function(a){d.myLog("Initial Render",4),d.myLog(a,4),d.heatData=a,d.renderFile(d.geoFileCountry,"provinces"),d.renderFile(d.geoFileRegion,"distrits"),d.scaleLegend()})})})}),$(".tab").on("click",function(){d.myLog("click tab!!",5),d3.select(".tab.selected ").classed("selected",!1),d3.select(this).classed("selected",!0);var a=d3.select(this).attr("name");d.tabSelected=a,d.myLog("new tab: "+d.tabSelected,5),d.infoDict[a].method(a),d.scaleLegend()})})}),d};var tdviz=tdviz||{version:.9,controller:{},viz:{},extras:{},comm:{}};tdviz.viz.mapViz=function(a,b,c){var d={};d.idName=a,d.className=b;for(var key in c)d[key]=c[key];return d._getId=function(a,b,c,e){return d.idCallBackDict&&c in d.idCallBackDict?d.idCallBackDict[c](a,b,e):a.id},d._init=function(){var a=["point","path","polygon"],b=["over","out","click","enter","exit","update","zoom"];d.callBacks={};for(var c=0;c<a.length;c++){var e=a[c];d.callBacks[e]={};for(var f=0;f<b.length;f++){var g=b[f];d.callBacks[e][g]=d.callBackDict&&e in d.callBackDict&&g in d.callBackDict[e]?d.callBackDict[e][g]:function(){}}}var h={center:new L.LatLng(d.initLatLng[0],d.initLatLng[1]),layers:[d.tileLayer]};if(d.mapOptions)for(var option in d.mapOptions)h[option]=d.mapOptions[option];d.map=new L.Map(d.idName,h),d.map._initPathRoot(),d._updateResolution(),d.svg=d3.select("#"+d.idName).select("svg"),d.g=d.hideOnZoom?d.svg.append("g").attr("class","leaflet-zoom-hide").on("mousemove",d._mousemove):d.svg.append("g").on("mousemove",d._mousemove),d.svg=d.g,d.tooltip=d3.select("body").append("div").attr("id","tooltip").html("").attr("class","tooltip").style("opacity",0),d.path=d3.geo.path().projection(d.project),d.line=d3.svg.line().interpolate("linear").x(function(a){return d.project(a)[0]}).y(function(a){return d.project(a)[1]}),d.layers={},d.layersPrimitives={},d.geoData={},d.heatmapLayers={},d.markerLayers={},d.map.on("viewreset",d._updateMapMove)},d.initMarkers=function(a){d.markerDefinitions=a},d.initMarkerLayer=function(a,b,c,e){for(var f=[],g=0;g<b.features.length;g++){var h=b.features[g];if("Point"==h.geometry.type){var i=L.marker([h.geometry.coordinates[1],h.geometry.coordinates[0]],{icon:L.AwesomeMarkers.icon(d.markerDefinitions[c(h,g)])});i.bindPopup(e(h,g)),f.push(i)}}var j=L.layerGroup(f);d.markerLayers[a]=j},d.initMarkerLayerCluster=function(a,b,c,e,f){for(var g=[],h=0;h<b.features.length;h++){var i=b.features[h];if("Point"==i.geometry.type){var j=L.marker([i.geometry.coordinates[1],i.geometry.coordinates[0]],{icon:L.AwesomeMarkers.icon(d.markerDefinitions[c(i,h)])});j.bindPopup(e(i,h)),g.push(j)}}for(var k=new L.MarkerClusterGroup(f),h=0;h<g.length;h++)k.addLayer(g[h]);d.markerLayers[a]=k},d.showMarkerLayer=function(a){d.markerLayers[a]&&d.map.addLayer(d.markerLayers[a])},d.removeMarkerLayer=function(a){d.markerLayers[a]&&d.map.removeLayer(d.markerLayers[a])},d.initHeatmapLayer=function(a,b,c,e){for(var f=L.TileLayer.heatMap(b),g=[],h=0;h<c.features.length;h++){var i=c.features[h];"Point"==i.geometry.type&&g.push({lat:i.geometry.coordinates[1],lon:i.geometry.coordinates[0],value:e(i)})}f.setData(g),d.heatmapLayers[a]=f},d.showHeatmapLayer=function(a){d.heatmapLayers[a]&&d.map.addLayer(d.heatmapLayers[a])},d.removeHeatmapLayer=function(a){d.heatmapLayers[a]&&d.map.removeLayer(d.heatmapLayers[a])},d.addLayer=function(a,b){d.layers[a]=d.svg.append("g").attr("layerName",a),d.geoData[a]={},d.geoData[a].geoPoints=[],d.geoData[a].geoPolygons=[],d.geoData[a].geoPaths=[],d.layersPrimitives[a]=b?b:{points:"circle"}},d.layerAttr=function(a,b,c){d.layers[a].attr(b,c)},d.emptyLayer=function(a){d.layers[a].remove(),d.addLayer(a,d.layersPrimitives[a])},d.render=function(a,b){d.geoData[b].geoPoints.length=0,d.geoData[b].geoPolygons.length=0,d.geoData[b].geoPaths.length=0,a.features.forEach(function(a){"Point"==a.geometry.type&&d.geoData[b].geoPoints.push(a),("Polygon"==a.geometry.type||"MultiPolygon"==a.geometry.type)&&d.geoData[b].geoPolygons.push(a),"LineString"==a.geometry.type&&d.geoData[b].geoPaths.push(a)}),d._updateResolution();var c=d.layers[b].selectAll(".polygons").data(d.geoData[b].geoPolygons,function(a,c){return d._getId(a,c,"polygon",b)});c.call(d.callBacks.polygon.update,b);var e=(c.enter().insert("path",".paths").attr("class","polygons").on("mouseover",function(a,b){d.callBacks.polygon.over(a,b)}).on("mouseout",function(a,b){d.callBacks.polygon.out(a,b)}).on("click",function(a,b){var c=this;d.callBacks.polygon.click(a,b,c)}).call(d.callBacks.polygon.enter,b),c.exit().call(d.callBacks.polygon.exit,b),d.layers[b].selectAll(".paths").data(d.geoData[b].geoPaths,function(a,c){return d._getId(a,c,"path",b)}));e.call(d.callBacks.path.update,b);var f=(e.enter().insert("path",".points").attr("class","paths").on("mouseover",function(a,b){d.callBacks.path.over(a,b)}).on("mouseout",function(a,b){d.callBacks.path.out(a,b)}).call(d.callBacks.path.enter,b),e.exit().call(d.callBacks.path.exit,b),d.layers[b].selectAll(".points").data(d.geoData[b].geoPoints,function(a,c){return d._getId(a,c,"point",b)}));f.call(d.callBacks.point.update,b);f.enter().append(d.layersPrimitives[b].points).attr("class","points").on("mouseover",function(a,b){d.callBacks.point.over(a,b)}).on("mouseout",function(a,b){d.callBacks.point.out(a,b)}).call(d.callBacks.point.enter,b),f.exit().call(d.callBacks.point.exit,b)},d.project=function(a){var b=d.map.latLngToLayerPoint(new L.LatLng(a[1],a[0]));return[b.x,b.y]},d._updateMapMove=function(){d._updateResolution();for(var a in d.layers){var b=d.layers[a].selectAll(".polygons").data(d.geoData[a].geoPolygons,function(b,c){return d._getId(b,c,"polygon",a)}),c=d.layers[a].selectAll(".paths").data(d.geoData[a].geoPaths,function(b,c){return d._getId(b,c,"path",a)}),e=d.layers[a].selectAll(".points").data(d.geoData[a].geoPoints,function(b,c){return d._getId(b,c,"point",a)});e.call(d.callBacks.point.zoom,a),b.call(d.callBacks.polygon.zoom,a),c.call(d.callBacks.path.zoom,a)}},d.updateValues=function(a){d._updateResolution();for(var b in d.layers)if(a.indexOf(b)>-1){var c=d.layers[b].selectAll(".polygons").data(d.geoData[b].geoPolygons,function(a,c){return d._getId(a,c,"polygon",b)}),e=d.layers[b].selectAll(".paths").data(d.geoData[b].geoPaths,function(a,c){return d._getId(a,c,"path",b)}),f=d.layers[b].selectAll(".points").data(d.geoData[b].geoPoints,function(a,c){return d._getId(a,c,"point",b)});f.call(d.callBacks.point.update,b),c.call(d.callBacks.polygon.update,b),e.call(d.callBacks.path.update,b)}},d._mousemove=function(){d.tooltip.style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY-12+"px")},d._updateResolution=function(){d.resolution=Math.pow(2,d.map.getZoom())/156543.034},d.getRealPixels=function(a,b){return a*d.resolution/Math.abs(Math.cos(b*Math.PI/180))},d.pathTween=function(a){return function(){for(var b=this,c=b.cloneNode(),d=b.cloneNode().getAttribute("dfinal"),e=b.getTotalLength(),f=(c.setAttribute("d",d),c).getTotalLength(),g=[0],h=0,i=a/Math.max(e,f);(h+=i)<1;)g.push(h);g.push(1);var j=g.map(function(a){var d=b.getPointAtLength(a*e),g=c.getPointAtLength(a*f);return d3.interpolate([d.x,d.y],[g.x,g.y])});return function(a){return 1>a?"M"+j.map(function(b){return b(a)}).join("L"):d}}},d._init(),d};var tdviz=tdviz||{version:.9,controller:{},viz:{},extras:{},comm:{}};tdviz.viz.punchcard=function(a){function b(a,b){var c=a;for(var d in b)a.hasOwnProperty(d)||(c[d]=b[d]);return c}var c={},d={debug_level:3};b(a,d),c.header_margin=0,c.margin=50;for(var e in a)c[e]=a[e];return c.container_id=c.id_name,c.begin=0,c.init_columns=c.labels[1].length,c.init_rows=c.labels[0].length,c.myLog=function(a,b){0!=c.debug_level&&b<=c.debug_level&&console.log(a)},c._mousemove=function(){c.tooltip.style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY-12+"px")},c._mouseover=function(a){c.tooltip.html(a+" consumers ("+(a/c.total*100).toFixed(2)+"%)").style("opacity",1)},c._mouseout=function(){c.tooltip.style("opacity",0)},c.init=function(){c.container=d3.select("#"+c.id_name),c.svg=c.container.append("svg").attr("width",c.width).attr("height",c.height).attr("style","padding-left:"+c.header_margin+";").on("mousemove",c._mousemove),c.tooltip=c.container.append("div").html("").attr("class","punch_tooltip").style("opacity",0),c.render(c.data)},c.render=function(a){c.columns=c.labels[1].length,c.rows=c.labels[0].length;var b=0;if(1==c.rows&&(b=105,c.begin=0),c.yScale=d3.scale.linear().domain([0,c.rows+1]).range([35+c.margin,c.height-c.margin-b]),c.xScale=d3.scale.linear().domain([0,c.columns+1]).range([35+c.margin,c.width-c.margin+120]),c.columns!=c.init_columns||c.rows!=c.init_rows||0==c.begin){c.svg.selectAll("text.headerH").remove(),c.svg.selectAll("text.headerV").remove(),c.svg.selectAll("circle.punches").remove(),c.init_columns=c.columns,c.init_rows=c.rows,c.begin=1;var d=c.svg.selectAll("text.headerH").data([c.headers[0]].concat(c.labels[0])),e=c.svg.selectAll("text.headerV").data([c.headers[1]].concat(c.labels[1]));d.enter().append("text").attr("class","headerH").attr("x",function(a,b){return c.xScale(0==b?c.rows/2+.5:b)}).attr("y",function(a,b){return 0==b?c.yScale(0)-35:c.yScale(0)}).attr("text-anchor","middle").text(function(a){return a}),e.enter().append("text").attr("class",function(a,b){return 0==b?"rotate headerV":"headerV"}).attr("x",function(a,b){return 0==b?-c.yScale(c.columns/2+.5):c.xScale(0)}).attr("y",function(a,b){return 0==b?c.yScale(0)-65-c.header_margin:c.yScale(b)}).attr("text-anchor","middle").text(function(a){return a})}c.total=0;for(var f in a)c.total+=a[f];c.myPunches=c.svg.selectAll("circle.punches").data(a),c.myPunches.enter().append("svg:circle").attr("class","punches").attr("cx",function(b,d){return c.xScale(d%(a.length/c.columns)+1)}).attr("cy",function(a,b){return c.yScale(Math.floor(b/c.rows)+1)}).attr("r",0).on("mouseover",function(a){c._mouseover(a)}).on("mouseout",c._mouseout),c.myPunches.transition().style("fill",function(a){return c.color_scale(a)}).attr("r",function(a){return c.size_scale(a)})},$(document).ready(function(){c.myLog("Chart Ready",4),c.init()}),c};